name: Build and Push Docker Image

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the Docker image'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      docker_context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      platforms:
        description: 'Platforms to build for (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      version_file:
        description: 'Path to VERSION file'
        required: false
        type: string
        default: './VERSION'
    secrets:
      oci_registry:
        description: 'OCI Registry URL (e.g., iad.ocir.io)'
        required: true
      oci_username:
        description: 'OCI Username'
        required: true
      oci_token:
        description: 'OCI Auth Token'
        required: true
      oci_namespace:
        description: 'OCIR Namespace'
        required: true
    outputs:
      version:
        description: 'Version read from VERSION file'
        value: ${{ jobs.build-and-push.outputs.version }}
      image_tags:
        description: 'Full image tags that were built'
        value: ${{ jobs.build-and-push.outputs.image_tags }}

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      image_tags: ${{ steps.extract-tags.outputs.tag_names }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Read VERSION file
        id: version
        run: |
          if [ -f "${{ inputs.version_file }}" ]; then
            VERSION=$(cat ${{ inputs.version_file }} | tr -d '[:space:]')
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Version from file: ${VERSION}"
          else
            echo "âš ï¸  VERSION file not found at ${{ inputs.version_file }}, using commit SHA only"
            echo "version=unset" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Login to OCI Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ${{ secrets.oci_registry }}
          username: ${{ secrets.oci_username }}
          password: ${{ secrets.oci_token }}

      - name: Generate Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051
        with:
          images: ${{ secrets.oci_registry }}/${{ secrets.oci_namespace }}/${{ inputs.image_name }}
          tags: |
            # Use VERSION file for version tag
            type=raw,value=${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.version != 'unset' }}
            # Always add commit SHA (short)
            type=sha,prefix=,format=short
            # Add 'latest' only on main branch push
            type=raw,value=latest
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Docker image
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
        with:
          context: ${{ inputs.docker_context }}
          file: ${{ inputs.dockerfile_path }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract tag names
        id: extract-tags
        run: |
          # Extract just the tag names (part after the last colon) from full image paths
          TAG_NAMES=$(echo "${{ steps.meta.outputs.tags }}" | sed 's/.*://g' | tr '\n' ',')
          echo "tag_names=${TAG_NAMES%,}" >> $GITHUB_OUTPUT
          echo "Extracted tag names: ${TAG_NAMES%,}"

      - name: Image summary
        run: |
          echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Name:** \`${{ inputs.image_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** \`${{ inputs.platforms }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Tags" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
